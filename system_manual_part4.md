### 4.3. スケジュール・シフト管理
目的: 生徒の利用予定とスタッフの勤務予定を組み合わせ、日々の運営に必要なシフト表を作成・管理します。

#### 構成要素:
- デフォルト勤務 (生徒基本情報管理アプリ内): スタッフの基本シフト。役割、担当習い事情報が重要。
- 生徒スケジュール (生徒基本情報管理アプリ内): 生徒の基本利用パターン。利用時間、習い事、送迎、シフト種類が重要。
- シフトデータ生成 (生徒基本情報管理アプリ内 機能):
  - 操作: 対象期間（開始日・終了日）とシフト種類（通常、プログラミングあり/なし等）を選択し、「データ生成」を実行。
  - 処理: 指定された条件に基づき、「デフォルト勤務」と「生徒スケジュール」の情報を組み合わせて、日ごとの「生徒予定実績」データを自動生成します。

- 生徒予定実績 (日次シフト):
  - 内容: 特定の日付の、生徒一人ひとりの詳細な予定（登所・降所時間、習い事、送迎、食事有無など）と、それに対応するスタッフの割り当て状況が表示されます。
  - スタッフ割り当て: 各コマ（時間帯や習い事）に対して、担当スタッフを選択します。選択肢には、「デフォルト勤務」で登録された担当可能なスタッフが表示されます。
  - イレギュラー対応:
    - 欠席: 該当生徒のレコードを開き、「当欠」等のステータスに変更。
    - 振替: 元の日付を欠席扱いとし、振替日のスケジュールに手動で追加（または振替用機能があれば利用）。
    - スポット利用: スケジュールにない生徒の利用を追加。
    - 時間変更: 登所・降所時間を直接編集。

  - データ更新: 編集内容を保存し、必要に応じて「シフトデータ更新」ボタンでバックエンドに反映。

- シフト表 (生徒基本情報管理アプリ内 機能):
  - 表示: 特定の日付を選択すると、時間軸に沿って全生徒・全スタッフの予定と割り当て状況が一覧表示されます。
  - 用途: シフト全体のバランス確認、スタッフ配置の調整、印刷して現場での確認用などに利用します。この画面からもスタッフ割り当て等の編集が可能です。

#### ワークフロー:
1. 事前準備: スタッフの「デフォルト勤務」（特に担当習い事）と生徒の「生徒スケジュール」（特にシフト種類）が最新かつ正確に登録されていることを確認。
2. データ生成: 次の期間（例：翌月分）のシフトを作成するため、「シフトデータ生成」機能で対象期間とシフト種類（通常は「通常」。隔週の場合は「あり」「なし」を分けて生成）を指定し、実行。
3. スタッフ割り当て: 生成された「生徒予定実績」または「シフト表」を開き、各コマに担当スタッフを割り当てる。担当可能なスタッフから選択。
4. イレギュラー反映: 保護者からの連絡（欠席、時間変更）やスポット利用希望などを、該当日の「生徒予定実績」に反映させる。
5. 最終確認・調整: 「シフト表」で全体の過不足やバランスを確認し、必要に応じてスタッフ配置を調整。
6. 情報共有: 完成したシフト情報をスタッフ間で共有（印刷、データ共有など）。

#### 注意点:
- 生成前のデータ確認: データ生成前にデフォルト勤務・生徒スケジュールの情報が正しいか確認することが重要です。間違いがあると、生成後の修正が煩雑になります。
- シフト種類の選択: データ生成時に正しいシフト種類を選択しないと、意図したスケジュールになりません（特に隔週の習い事）。
- スタッフ割り当て: 担当可能な習い事設定に基づき候補が表示されるため、事前の「デフォルト勤務」登録が正確であることが前提です。
- 編集と更新: 「生徒予定実績」や「シフト表」で編集した内容は、保存操作と、必要に応じて「シフトデータ更新」ボタンを押すことで反映されます。

### 4.4. 請求管理
目的: 毎月の利用実績に基づき請求額を正確に計算し、請求書発行、口座引き落としデータ作成、メール送信までの一連のプロセスを管理します。

#### 構成要素:
- 請求スケジュール (生徒基本情報管理アプリ内):
  - 月ごとに設定された請求関連タスクの締切日（例：請求確定日、PDF・Gコレクト生成日、メール送信日）を確認できます。

- 請求明細データ生成 (生徒基本情報管理アプリ内 機能):
  - 操作: 対象月を選択し、請求対象（「月決め」「保育・食事等」「長期休み」など）にチェックを入れて「データ生成」を実行。通常は「月決め」と「保育・食事等」を別々に生成します。長期休み月は「長期休み」も生成。
  - 計算ロジック:
    - 月決め: 「会員契約」の月額料金関連項目（施設維持費、エデュテン等）を集計。
    - 保育・食事等: 「生徒予定実績」の日次データから、保育時間、食事回数、習い事受講回数、送迎利用回数などをカウントし、登録された単価に基づいて料金を計算。
    - 長期休み: 「長期休みアプリ」で入力された利用希望と、「生徒予定実績」の実際利用データに基づき、「コマ数差額」を計算（後述）。イベント参加費なども集計。

- 請求明細 (生徒基本情報管理アプリ内):
  - 内容: 生成された月次の請求明細がリスト表示されます。生徒ごとに、各請求項目（保育料、食事代、習い事代、施設維持費、コマ数差額など）と合計金額を確認できます。
  - 手動修正: 自動計算結果に誤りがある場合や、特別な割引・追加料金がある場合に、この画面で直接金額を修正できます。修正理由は必ず記録（メモ欄など）に残してください。
  - コマ数差額 (長期休み):
    - 概念: 長期休み前に、通常の月額保育料（例：週2回契約分）を前払いとして請求します。その後、長期休み期間中の実際の利用コマ数を「生徒予定実績」からカウントし、前払い分との差額を計算します。利用が多ければ追加請求、少なければ返金（または翌月調整）となります。
    - 計算: システムが自動計算しますが、ロジックが複雑なため、計算根拠となるデータ（契約コマ数、実績コマ数、単価）を確認することが重要です。

- 請求確定 (生徒基本情報管理アプリ内 機能):
  - 操作: 請求内容の最終確認後、「請求確定」ボタンを押します。
  - 効果: 請求内容がロックされ、以降の修正ができなくなります。PDF・Gコレクト生成の前提となります。
  - 注意点: 締切日（請求スケジュール参照）までに必ず実行 してください。確定後の修正は原則不可であり、解除には管理者への依頼が必要です。

- PDF・Gコレクト生成 (生徒基本情報管理アプリ内 機能):
  - 操作: 請求確定後、「PDF生成」「Gコレクト生成」ボタンを押します。
  - 処理:
    - PDF: 確定した請求明細に基づき、保護者向けの請求書PDFファイルが生成されます。
    - Gコレクト: 銀行引き落とし用のデータファイル（金融機関指定形式）が生成されます。口座情報が登録されている保護者のみ対象となります。

- メール送信 (生徒基本情報管理アプリ内 機能):
  - 操作: PDF生成後、対象者を選択（または一括選択）し、「メール送信」ボタンを押します。
  - 処理: 生成された請求書PDFが添付されたメールが、保護者情報に登録されているメールアドレス宛に送信されます。テンプレート選択可能。 